{% extends "base.html" %} {% block content %}
<section class="panel panel--nochrome">
  <div class="controls" style="grid-template-columns: 3fr 2fr">
    <div class="subpanel">
    <div class="control-group" style="margin-bottom:8px">
      <h1 style="margin:0 0 4px 0">Preprocessing</h1>
      <p class="muted" style="margin:0">Prepare a video for tracking: define arena and background.</p>
    </div>
    <div class="control-group">
      <label>Video</label>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
        <input
          type="text"
          id="preproc-video-path"
          value="{{ video or '' }}"
          readonly
          style="flex:1"
        />
        <div id="pp-day-strip" class="muted" style="display:flex; gap:6px; flex-wrap:wrap"></div>
      </div>
    </div>

    <div class="control-group">
      <div class="video-wrap">
        <div class="video-preview">
          
          <div id="pp-vwrap" style="position: relative">
            <video
              id="pp-video"
              preload="metadata"
              {% if video %}src="/media?path={{ video|urlencode }}"{% endif %}
              style="display: block; width: 100%; height: auto"
            ></video>
            <canvas
              id="pp-processed"
              style="
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                display: none;
              "
            ></canvas>
            <canvas
              id="pp-overlay"
              style="
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                pointer-events: auto;
              "
            ></canvas>
            <div
              id="pp-handle-tl"
              style="
                position: absolute;
                width: 12px;
                height: 12px;
                background: #4f8cff;
                border: 2px solid #fff;
                border-radius: 2px;
                transform: translate(-50%, -50%);
                display: none;
                cursor: nwse-resize;
              "
            ></div>
            <div
              id="pp-handle-br"
              style="
                position: absolute;
                width: 12px;
                height: 12px;
                background: #4f8cff;
                border: 2px solid #fff;
                border-radius: 2px;
                transform: translate(-50%, -50%);
                display: none;
                cursor: nwse-resize;
              "
            ></div>
          </div>
          <div class="controls-row" style="margin-top: 8px">
            <button
              class="icon-btn"
              id="pp-play"
              title="Play"
              aria-label="Play"
              style="margin-left: 6px"
            >
              ▶
            </button>
            <div class="fill">
              <input
                type="range"
                id="pp-seek"
                min="0"
                value="0"
                step="0.01"
                style="width: 100%"
              />
            </div>
            <div
              class="muted"
              id="pp-time"
              style="
                margin-right: 6px;
                font-family: ui-monospace, Menlo, Monaco, Consolas, monospace;
              "
            >
              00:00 / 00:00
            </div>
          </div>
          <div
            class="controls-row"
            style="margin-top: 6px; align-items: center"
          >
            <span class="muted">Filter</span>
            <div id="pp-filter-chips" class="fill" style="display:flex; gap:6px; align-items:center">
              <button class="chip" data-filter="invert">Invert</button>
              <button class="chip" data-filter="histeq">Hist Eq</button>
            </div>
            <span class="muted" style="min-width: 1px"></span>
          </div>
        </div>
      </div>
      <div class="muted" style="margin-top: 6px">
        Tip: Click to set top-left, then bottom-right of the arena.
      </div>
    </div>
    </div> <!-- end left subpanel -->

    <div class="subpanel">
    <div class="control-group">
      <div class="kv" style="margin-bottom:8px">
        <div class="k">Facility</div>
        <select id="pp-facility"></select>
        <div class="k">Setup</div>
        <div style="display:flex; gap:6px; align-items:center">
          <select id="pp-setup" style="flex:1"></select>
          <button class="btn mini" id="pp-apply-setup" title="Apply selected setup values to the tabs">Apply</button>
          <button class="btn mini" id="pp-save-setup" title="Save current settings as a setup (overwrite or add new)">Save...</button>
        </div>
        <div class="k"></div>
        <div class="v"><span id="pp-setup-status" class="muted"></span></div>
      </div>
      <div class="muted" id="pp-matlab-status" style="margin: 2px 0 8px 0">MATLAB: Checking…</div>
      <div
        class="tabs small"
        style="display: flex; gap: 8px; margin-bottom: 8px"
      >
        <button class="btn mini" id="tab-arena">Arena</button>
        <button class="btn mini" id="tab-background">Background</button>
        <button class="btn mini" id="tab-regions">Regions</button>
        <button class="btn mini" id="tab-colors">Colors</button>
        <button class="btn mini" id="tab-save">Save…</button>
      </div>
      <div id="pp-panes" style="position:relative">
      <div id="pane-arena">
        <div class="kv">
          <div class="k">Grid cols</div>
          <input type="number" id="grid-cols" min="1" value="6" />
          <div class="k">Grid rows</div>
          <input type="number" id="grid-rows" min="1" value="4" />
          <div class="k">Width (cm)</div>
          <input type="number" id="arena-wcm" min="1" value="40" />
          <div class="k">Height (cm)</div>
          <input type="number" id="arena-hcm" min="1" value="30" />
        </div>
        <div class="muted" style="margin-top: 6px">
          Arena is axis-aligned rectangle within the frame. Click Mark to
          define: top-left then bottom-right. Drag handles to refine while
          marking. Arrow keys nudge (Shift = 10px).
        </div>
        <div
          style="display: flex; gap: 8px; align-items: center; margin-top: 8px"
        >
          <button class="btn" id="arena-mark">Mark</button>
          <span class="muted" id="arena-status"></span>
        </div>
      </div>
      <div id="pane-background" style="display: none">
        <div class="kv">
          <div class="k">Frames</div>
          <input type="number" id="bg-frames" min="5" max="200" value="25" />
          <div class="k">Quantile</div>
          <input
            type="number"
            id="bg-quant"
            min="0"
            max="100"
            step="1"
            value="50"
          />
        </div>
        <div
          style="display: flex; gap: 8px; align-items: center; margin: 8px 0"
        >
          <button class="btn" id="bg-run">Run</button>
          <button class="btn" id="bg-save">Save</button>
          <span class="muted" id="bg-status"></span>
        </div>
        <canvas
          id="bg-canvas"
          style="
            width: 100%;
            max-width: 100%;
            border: 1px solid var(--border);
            border-radius: 8px;
          "
        ></canvas>
      </div>
      <div id="pane-regions" style="display: none">
        <div class="table-wrap" style="padding: 0; margin-top: 8px">
          <table
            id="roi-table"
            style="width: 100%; border-collapse: collapse; font-size: 13px"
          >
            <thead>
              <tr>
                <th style="text-align: left; padding: 6px">Name</th>
                <th style="text-align: left; padding: 6px">Enabled</th>
                <th style="text-align: left; padding: 6px">Sheltered</th>
                <th style="text-align: left; padding: 6px">Cells</th>
                <th style="text-align: left; padding: 6px"></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div style="display:flex; align-items:center; justify-content:flex-end; gap:8px; margin-top:8px">
          <span class="muted" id="roi-status" style="margin-right:auto"></span>
          <button class="btn" id="roi-add">Add</button>
        </div>
        
        <div class="muted" style="margin-top: 6px">
          Tip: Click "Edit" for a region, then click grid cells in the
          overlay to toggle. Press Esc or click Edit again to finish.
        </div>
      </div>
      <div id="pane-colors" style="display: none">
        <div class="controls-row" style="align-items:center; gap:12px; margin: 8px 0; flex-wrap: wrap">
          <label style="display:flex; align-items:center; gap:6px">
            <input type="checkbox" id="pp-colors-segments" /> Show segments
          </label>
          <label style="display:flex; align-items:center; gap:8px">
            <span class="muted">Bounds thickness</span>
            <input type="range" id="pp-colors-thickness" min="0" max="8" step="1" value="2" />
            <span class="muted" id="pp-colors-thickness-val">2</span>
          </label>
          <button class="btn mini" id="pp-colors-remove" title="Remove mark for selected mouse in current frame">Remove mark</button>
          <button class="btn mini" id="pp-colors-clear" title="Clear all marks">Clear marks</button>
          <button class="btn mini" id="pp-colors-random" title="Jump to a random frame">Random frame</button>
          <span class="muted" id="pp-colors-status" style="min-width:200px"></span>
        </div>
        <div class="controls-row" style="align-items:center; gap:12px; margin: 8px 0; flex-wrap: wrap">
          <div id="pp-colors-selected" class="muted">Mouse: 1</div>
          <div id="pp-colors-legend" class="muted"></div>
        </div>
        <div class="controls-row" style="align-items:flex-start; gap:12px; margin: 8px 0; flex-wrap: wrap">
          <div>
            <div class="muted" style="margin-bottom:4px">Marked counts</div>
            <div id="pp-colors-hist" class="muted"></div>
          </div>
        </div>
        <div class="muted" style="margin-top: 6px">
          When open, frames are segmented by color in MATLAB (RGBY). White outlines always show cluster boundaries; enable “Show segments” to overlay colored fills.
        </div>
      </div>
      <div id="pane-save" style="display:none">
        <div class="muted" style="margin-bottom:6px">Save arena, regions, and colors to the selected days (backgrounds remain per day).</div>
        <div id="pp-mday-summary" class="muted" style="margin:6px 0">Group: —</div>
        <div id="pp-mday-list" style="max-height:160px; overflow:auto; border:1px solid var(--border); border-radius:8px; padding:6px"></div>
        <div style="display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap">
          <button class="btn mini" id="pp-mday-all">All</button>
          <button class="btn mini" id="pp-mday-none">None</button>
          <span class="muted" id="pp-mday-count"></span>
        </div>
        <div style="display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap">
          <button class="btn" id="pp-mday-save">Save preproc → selected days</button>
          <button class="btn" id="pp-save-final">Save preproc → current video</button>
        </div>
        <div class="muted" id="pp-mday-status" style="margin-top:6px"></div>
      </div>
      </div> <!-- end #pp-panes -->
    </div>
    </div> <!-- end right subpanel -->
  </div>
 </section>

<script>
  // New modular JS includes for Preproc
  window.PREPROC_VIDEO = {{ (video or '')|tojson }};
</script>
<script src="/static/preproc/shared.js"></script>
<script src="/static/preproc/arena.js"></script>
<script src="/static/preproc/background.js"></script>
<script src="/static/preproc/filters.js"></script>
<script src="/static/preproc/regions.js"></script>
<script src="/static/preproc/colors.js"></script>
<script src="/static/preproc/main.js"></script>
{% endblock %}
